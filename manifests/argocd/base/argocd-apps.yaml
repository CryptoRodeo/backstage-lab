# =======================================================================
# Basic ArgoCD Apps
# =======================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backstage-argocd-defaults
  namespace: demo-apps
  labels:
    environment: staging
    app: nginx
    type: demo
    app.kubernetes.io/instance: backstage-argocd-defaults # Should match one of the app names
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:1.14.2
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: basic-app-svc
  namespace: demo-apps
spec:
  ports:
    - port: 80
      targetPort: 80
  selector:
    app: nginx
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: guestbook-ui
  namespace: demo-apps
spec:
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: guestbook-ui
  template:
    metadata:
      labels:
        app: guestbook-ui
    spec:
      containers:
        - image: gcr.io/heptio-images/ks-guestbook-demo:0.1
          name: guestbook-ui
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: guestbook-ui
  namespace: demo-apps
spec:
  ports:
    - port: 80
      targetPort: 80
  selector:
    app: guestbook-ui
---
# =======================================================================
# CANARY ROLLOUT
# =======================================================================
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: rollout-canary-translation-test
  namespace: backstage-argocd
  labels:
    app.kubernetes.io/instance: backstage-argocd-defaults # Should match one of the app names
    app: rollout-canary
    backstage.io/kubernetes-id: rollouts-canary-test
    backstage.io/test-resource: "true"
  annotations:
    backstage.io/description: "Canary rollout for testing Backstage ArgoCD plugin"
    rollout.argoproj.io/revision: "1"
spec:
  replicas: 3
  strategy:
    canary:
      canaryService: rollout-canary-canary
      stableService: rollout-canary-stable
      steps:
        - setWeight: 20
        - pause:
            duration: 10s
        - setWeight: 40
        - pause:
            duration: 10s
        - setWeight: 60
        - pause:
            duration: 10s
        - setWeight: 80
        - pause:
            duration: 10s
        - setWeight: 100
  selector:
    matchLabels:
      app: canary-demo
      app.kubernetes.io/instance: backstage-argocd-defaults
  template:
    metadata:
      labels:
        app: canary-demo
        app.kubernetes.io/instance: backstage-argocd-defaults
        backstage.io/kubernetes-id: rollouts-canary-test
    spec:
      containers:
        - name: rollouts-demo
          image: argoproj/rollouts-demo:blue
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          resources:
            requests:
              memory: 32Mi
              cpu: 5m
            limits:
              memory: 128Mi
              cpu: 100m
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 3000
            seccompProfile:
              type: "RuntimeDefault"
---
# =======================================================================
# BLUE-GREEN ROLLOUT
# =======================================================================
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: rollout-bluegreen-translation-test
  namespace: backstage-argocd
  labels:
    app.kubernetes.io/instance: backstage-argocd-defaults # Should match one of the app names
    app: rollout-bluegreen
    backstage.io/kubernetes-id: rollouts-bluegreen-test
    backstage.io/test-resource: "true"
  annotations:
    backstage.io/description: "Blue-Green rollout for testing Backstage ArgoCD plugin"
    rollout.argoproj.io/revision: "1"
spec:
  replicas: 2
  strategy:
    blueGreen:
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      autoPromotionEnabled: false
      scaleDownDelaySeconds: 30
  selector:
    matchLabels:
      app: bluegreen-demo
      app.kubernetes.io/instance: backstage-argocd-defaults
  template:
    metadata:
      labels:
        app: bluegreen-demo
        app.kubernetes.io/instance: backstage-argocd-defaults
        backstage.io/kubernetes-id: rollouts-bluegreen-test
    spec:
      containers:
        - name: rollouts-demo
          image: argoproj/rollouts-demo:blue
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          resources:
            requests:
              memory: 32Mi
              cpu: 5m
            limits:
              memory: 128Mi
              cpu: 100m
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 3000
            seccompProfile:
              type: "RuntimeDefault"
---
# =======================================================================
# SERVICES FOR CANARY ROLLOUT
# =======================================================================
apiVersion: v1
kind: Service
metadata:
  name: rollout-canary-stable
  namespace: backstage-argocd
  labels:
    app.kubernetes.io/instance: backstage-argocd-defaults
    backstage.io/kubernetes-id: rollouts-canary-test
    backstage.io/test-resource: "true"
spec:
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app: canary-demo
    app.kubernetes.io/instance: backstage-argocd-defaults
---
apiVersion: v1
kind: Service
metadata:
  name: rollout-canary-canary
  namespace: backstage-argocd
  labels:
    app.kubernetes.io/instance: backstage-argocd-defaults
    backstage.io/kubernetes-id: rollouts-canary-test
    backstage.io/test-resource: "true"
spec:
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app: canary-demo
    app.kubernetes.io/instance: backstage-argocd-defaults
---
# =======================================================================
# SERVICES FOR BLUE-GREEN ROLLOUT
# =======================================================================
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
  namespace: backstage-argocd
  labels:
    app.kubernetes.io/instance: backstage-argocd-defaults
    backstage.io/kubernetes-id: rollouts-bluegreen-test
    backstage.io/test-resource: "true"
spec:
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app: bluegreen-demo
    app.kubernetes.io/instance: backstage-argocd-defaults
---
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
  namespace: backstage-argocd
  labels:
    app.kubernetes.io/instance: backstage-argocd-defaults
    backstage.io/kubernetes-id: rollouts-bluegreen-test
    backstage.io/test-resource: "true"
spec:
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app: bluegreen-demo
    app.kubernetes.io/instance: backstage-argocd-defaults
---

